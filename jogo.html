
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Stop Game - Rodada</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: #f4f4f4; padding: 20px; }
    input { margin: 5px; padding: 5px; }
    #pontuacoes, #timer { margin-top: 20px; font-size: 20px; }
    #respostasTabela { margin: 20px auto; border-collapse: collapse; width: 80%; }
    #respostasTabela td, #respostasTabela th { border: 1px solid #ccc; padding: 8px; }
    #stopBtn { margin-top: 20px; font-size: 20px; padding: 10px 30px; }
  </style>
</head>
<body>
  <h2>Rodada <span id="numRodada">1</span>/10</h2>
  <div id="letraAtual">Letra: <strong id="letra">A</strong></div>
  <div id="categorias"></div>
  <button id="stopBtn" onclick="enviarRespostas()">STOP!</button>
  <div id="timer"></div>
  <div id="pontuacoes"></div>
  <div style="margin-top:30px;">
    <button onclick="window.location.href='index.html'">Voltar ao Menu</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpQw82Ng1YXX2ojYurHk7cc72p3miTFNk",
      authDomain: "stop-game-1ecb9.firebaseapp.com",
      databaseURL: "https://stop-game-1ecb9-default-rtdb.firebaseio.com",
      projectId: "stop-game-1ecb9",
      storageBucket: "stop-game-1ecb9.appspot.com",
      messagingSenderId: "951084529297",
      appId: "1:951084529297:web:26484b0f33ffedead7b130"
    };
    firebase.initializeApp(firebaseConfig);

    const urlParams = new URLSearchParams(window.location.search);
    const salaId = urlParams.get("id");
    let rodada = parseInt(urlParams.get("rodada") || "0");
    let letra = '';
    let categorias = [];
    let usuario = null;
    let rodadaFinalizada = false;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        usuario = user;
        carregarDadosSala();
      }
    });

    function carregarDadosSala() {
      firebase.database().ref(`sessoes/${salaId}`).once("value").then(snap => {
        const dados = snap.val();
        letra = dados.letras[rodada];
        categorias = dados.categorias;
        document.getElementById("letra").innerText = letra;
        document.getElementById("numRodada").innerText = rodada + 1;
        renderizarCampos();

let tempoRestante = 60;
const timerDiv = document.getElementById("timer");
const intervaloRodada = setInterval(() => {
  if (rodadaFinalizada) {
    clearInterval(intervaloRodada);
    return;
  }
  tempoRestante--;
  timerDiv.innerText = "Tempo restante: " + tempoRestante + "s";
  if (tempoRestante <= 0) {
    clearInterval(intervaloRodada);
    enviarRespostas();
  }
}, 1000);

      });

      firebase.database().ref(`sessoes/${salaId}/status_rodada`).on("value", snap => {
        if (snap.val() === "finalizada" && !rodadaFinalizada) {
          rodadaFinalizada = true;
          exibirPontuacoesRodada();
        }
      });
    }

    function renderizarCampos() {
      const div = document.getElementById("categorias");
      div.innerHTML = "";
      categorias.forEach(cat => {
        const label = document.createElement("label");
        label.innerText = cat + ": ";
        const input = document.createElement("input");
        input.id = cat;
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(document.createElement("br"));
      });
    }

    function enviarRespostas() {
      if (rodadaFinalizada) return;
      rodadaFinalizada = true;

      const respostas = {};
      categorias.forEach(cat => {
        const val = document.getElementById(cat).value.trim();
        respostas[cat] = val;
      });

      firebase.database().ref(`sessoes/${salaId}/respostas/${rodada}/${usuario.uid}`).set(respostas);
      firebase.database().ref(`sessoes/${salaId}/status_rodada`).set("finalizada");
    }

    function exibirPontuacoesRodada() {
      firebase.database().ref(`sessoes/${salaId}/respostas/${rodada}`).once("value").then(snap => {
        const respostas = snap.val() || {};
        const tabela = document.createElement("table");
        tabela.id = "respostasTabela";
        const header = document.createElement("tr");
        header.innerHTML = "<th>Jogador</th>" + categorias.map(c => `<th>${c}</th>`).join("");
        tabela.appendChild(header);

        const contagem = {};
        for (let uid in respostas) {
          categorias.forEach(cat => {
            const r = (respostas[uid][cat] || "").toLowerCase();
            if (!contagem[cat]) contagem[cat] = {};
            contagem[cat][r] = (contagem[cat][r] || 0) + 1;
          });
        }

        for (let uid in respostas) {
          const linha = document.createElement("tr");
          const jogadorNome = uid.substring(0,6);
          linha.innerHTML = `<td>${jogadorNome}</td>`;
          categorias.forEach(cat => {
            const resp = (respostas[uid][cat] || "").toLowerCase();
            const rep = contagem[cat][resp];
            let pts = 0;
            if (resp === "") pts = 0;
            else if (rep === 1) pts = 100;
            else if (rep === 2) pts = 50;
            else if (rep === 3) pts = 33;
            else if (rep === 4) pts = 25;
            else if (rep === 5) pts = 20;
            else if (rep === 6) pts = 18;
            else if (rep === 7) pts = 14;
            else if (rep === 8) pts = 13;
            else if (rep === 9) pts = 11;
            else pts = 10;
            linha.innerHTML += `<td>${resp} (${pts})</td>`;
          });
          tabela.appendChild(linha);
        }

        const div = document.getElementById("pontuacoes");
        div.innerHTML = "<h3>Resultado da Rodada</h3>";
        div.appendChild(tabela);

        iniciarContadorProximaRodada();
      });
    }

    function iniciarContadorProximaRodada() {
      let segundos = 15;
      const timer = document.getElementById("timer");
      timer.innerText = "Sorteando nova letra em " + segundos + "s";
      const intervalo = setInterval(() => {
        segundos--;
        timer.innerText = "Sorteando nova letra em " + segundos + "s";
        if (segundos <= 0) {
          clearInterval(intervalo);
          window.location.href = `jogo.html?id=${salaId}&rodada=${rodada + 1}`;
        }
      }, 1000);
    }
  </script>
</body>
</html>
